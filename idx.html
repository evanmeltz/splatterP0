<!DOCTYPE html>
<html>
<head>
  <title>Spline-Based Paint Trail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    #map { height: 100vh; width: 100%; }
    .avatar-marker {
      border-radius: 50%;
      width: 12px;
      height: 12px;
      display: block;
      border: 2px solid white;
    }
    #teamSelect, #resetButton {
      position: absolute;
      z-index: 1000;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      font-family: sans-serif;
    }
    #teamSelect { top: 10px; left: 10px; }
    #resetButton { top: 10px; right: 10px; }
  </style>
</head>
<body>
  <div id="teamSelect">
    <button onclick="selectTeam('red')">Join Red Team</button>
    <button onclick="selectTeam('blue')">Join Blue Team</button>
  </div>
  <div id="resetButton">
    <button onclick="resetBoard()">Reset Board</button>
  </div>
  <div id="map"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC3hOrQI0Y3YvknYEfP4k-QsVuDmjNqiGs",
      authDomain: "splatterbattlep1.firebaseapp.com",
      projectId: "splatterbattlep1",
      storageBucket: "splatterbattlep1.firebasestorage.app",
      messagingSenderId: "481770863921",
      appId: "1:481770863921:web:0286b9918a3efbb6020410",
      measurementId: "G-8P8WGL35CK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const useRealGPS = false;
    const centerLat = 47.6849, centerLng = -122.1183;
    const map = L.map('map').setView([centerLat, centerLng], 18);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/">CARTO</a>', subdomains: 'abcd', maxZoom: 20
    }).addTo(map);

    let teamColor = null;
    let avatar = null;
    let playerTrail = [];
    let lastUploadTime = 0;

    const trailsLayer = L.layerGroup().addTo(map);

    function drawArea(geojson, color) {
      if (!geojson) return;
      L.geoJSON(geojson, {
        style: { color: color, weight: 1, fillOpacity: 0.4 }
      }).addTo(trailsLayer);
    }

    async function fetchAndDrawAllTeams() {
      trailsLayer.clearLayers();
      const teams = ["red", "blue"];
      for (const team of teams) {
        const merged = await fetchTeamGeometry(team);
        drawArea(merged, team);
        if (team === teamColor && merged) {
          const m2 = turf.area(merged);
          console.log(`Team ${team} controls ~${Math.round(m2)} mÂ²`);
        }
      }
    }

    async function fetchTeamGeometry(team) {
      const snapshot = await db.collection("trails").where("team", "==", team).get();
      const buffers = [];
      snapshot.forEach(doc => {
        const { path } = doc.data();
        if (Array.isArray(path) && path.length >= 2) {
          const coords = path.map(p => [p.lng, p.lat]);
          const line = turf.lineString(coords);
          try {
            const buffer = turf.buffer(line, 10, { units: 'meters' });
            if (buffer) buffers.push(turf.cleanCoords(buffer));
          } catch (e) {
            console.warn("Buffering failed", e);
          }
        }
      });
      let merged = null;
      for (const geom of buffers) {
        if (!merged) merged = geom;
        else {
          try {
            merged = turf.union(merged, geom);
          } catch (e) {
            console.warn("Union failed", e);
          }
        }
      }
      return merged;
    }

    async function uploadTrail() {
      if (playerTrail.length < 2) return;
      const now = Date.now();
      if (now - lastUploadTime < 3000) return;
      lastUploadTime = now;

      const docRef = db.collection("trails").doc();
      await docRef.set({
        team: teamColor,
        path: playerTrail.map(p => ({ lat: p[0], lng: p[1] })),
        timestamp: now
      });

      playerTrail = [];
    }

    async function updatePosition(lat, lng) {
      if (!teamColor) return;

      playerTrail.push([lat, lng]);
      if (avatar) avatar.setLatLng([lat, lng]);
      map.panTo([lat, lng]);

      await uploadTrail();
    }

    function startKeyboardControls() {
      document.addEventListener("keydown", (e) => {
        let moved = false;
        let lat = avatar.getLatLng().lat;
        let lng = avatar.getLatLng().lng;
        const delta = 0.00005; // ~5m
        if (e.key === "ArrowUp") lat += delta, moved = true;
        else if (e.key === "ArrowDown") lat -= delta, moved = true;
        else if (e.key === "ArrowLeft") lng -= delta, moved = true;
        else if (e.key === "ArrowRight") lng += delta, moved = true;
        if (moved) updatePosition(lat, lng);
      });
    }

    function startLiveSync() {
      db.collection("trails").onSnapshot(() => {
        fetchAndDrawAllTeams();
      });
    }

    async function selectTeam(color) {
      teamColor = color;
      document.getElementById('teamSelect').style.display = 'none';
      const avatarIcon = L.divIcon({
        className: '',
        html: `<span class="avatar-marker" style="background-color: ${teamColor}"></span>`,
        iconSize: [16, 16],
        iconAnchor: [8, 8]
      });
      avatar = L.marker([centerLat, centerLng], { icon: avatarIcon }).addTo(map);

      updatePosition(centerLat, centerLng);
      if (useRealGPS) startGPS();
      else startKeyboardControls();
    }

    function startGPS() {
      navigator.geolocation.watchPosition(pos => {
        updatePosition(pos.coords.latitude, pos.coords.longitude);
      }, err => console.error("GPS Error", err), {
        enableHighAccuracy: true, maximumAge: 0, timeout: 5000
      });
    }

    function resetBoard() {
      db.collection("trails").get().then(snapshot => {
        const batch = db.batch();
        snapshot.forEach(doc => batch.delete(doc.ref));
        batch.commit().then(() => location.reload());
      });
    }

    fetchAndDrawAllTeams();
    startLiveSync();
  </script>
</body>
</html>
